<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mobility Age Calculator — FINAL (Gmail‑friendly)</title>
  <style>
body{font-family:Segoe UI,Arial,sans-serif;margin:0;background:#f7f7fb;color:#111}
.container{max-width:980px;margin:24px auto;padding:16px 20px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
h1{font-size:22px;margin:0 0 4px} .muted{color:#6b7280;font-size:12px}
.row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.row-6{display:grid;grid-template-columns:repeat(6,1fr);gap:16px}
.card{border:1px solid #e5e7eb;border-radius:10px;padding:12px}
label{font-size:12px;color:#374151;margin-bottom:4px;display:block}
input,select{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px}
button{border:0;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn{background:#2563eb;color:#fff} .btn:hover{background:#1d4ed8}
.btn-lite{background:#f3f4f6} .btn-lite:hover{background:#e5e7eb}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{padding:8px 10px;text-align:left;border-bottom:1px solid #eee}
.kv{font-size:12px;color:#6b7280}
.header{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:16px}
.badge{display:inline-block;background:#ecfdf5;color:#065f46;padding:4px 8px;border:1px solid #a7f3d0;border-radius:999px;font-size:12px}
.err{display:none;margin-bottom:12px;padding:10px;border-radius:8px;background:#fef2f2;color:#991b1b;border:1px solid #fecaca;font-size:13px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>Mobility Age Calculator <span class="muted">(Embedded Norms)</span></h1>
        <div>
          <span id="boot" class="badge">Boot: pending…</span>
          <span id="core" class="badge">Core: pending…</span>
          <span id="normsStatus" class="badge">Norms: pending…</span>
        </div>
      </div>
      <div>
        <button id="btnPrint" class="btn-lite" onclick="window.print()">Print / Save PDF</button>
        <button id="btnReset" class="btn-lite" onclick="doReset()">Reset</button>
      </div>
    </div>

    <div id="err" class="err"></div>

    <h3>Inputs</h3>
    <div class="row-6">
      <div><label>Name</label><input id="inpName" type="text" placeholder="Optional" /></div>
      <div>
        <label>Sex</label>
        <select id="inpSex">
          <option value="">Select</option>
          <option value="Female">Female</option>
          <option value="Male">Male</option>
        </select>
      </div>
      <div><label>Age (years)</label><input id="inpAge" type="number" min="20" max="89" step="1" placeholder="e.g., 72" /></div>
    </div>

    <div class="row" style="margin-top:16px">
      <div class="card"><label>Timed Up & Go (TUG), seconds</label><input id="inpTUG" type="number" step="0.01" placeholder="e.g., 8.7" /><div class="kv">Lower is better</div></div>
      <div class="card"><label>Sit & Reach, inches</label><input id="inpSR" type="number" step="0.1" placeholder="e.g., 12" /></div>
      <div class="card"><label>VO<sub>2</sub>max, ml/kg/min</label><input id="inpVO2" type="number" step="0.1" placeholder="e.g., 34" /></div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="card"><label>MTP, percentile (0–100)</label><input id="inpMTPpct" type="number" step="0.1" min="0" max="100" placeholder="e.g., 60" /></div>
      <div class="card">
        <label>Grip, percentiles (R & L)</label>
        <div class="row" style="grid-template-columns:1fr 1fr;gap:8px">
          <input id="inpGripR" type="number" step="0.1" min="0" max="100" placeholder="Right %" />
          <input id="inpGripL" type="number" step="0.1" min="0" max="100" placeholder="Left %" />
        </div>
        <div id="gripAvgLbl" class="kv" style="margin-top:6px">Average: —</div>
      </div>
      <div class="card">
        <label>Sway, percentiles (R & L)</label>
        <div class="row" style="grid-template-columns:1fr 1fr;gap:8px">
          <input id="inpSwayR" type="number" step="0.1" min="0" max="100" placeholder="Right %" />
          <input id="inpSwayL" type="number" step="0.1" min="0" max="100" placeholder="Left %" />
        </div>
        <div id="swayAvgLbl" class="kv" style="margin-top:6px">Average: —</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="kv">Config</div>
      <div class="row" style="grid-template-columns:repeat(6,1fr);gap:8px;margin-top:6px">
        <div><label>VO2 weight</label><input id="wVO2" type="number" step="0.01" value="1.50" /></div>
        <div><label>TUG weight</label><input id="wTUG" type="number" step="0.01" value="1.25" /></div>
        <div><label>Sit & Reach weight</label><input id="wSR" type="number" step="0.01" value="1.00" /></div>
        <div><label>MTP weight</label><input id="wMTP" type="number" step="0.01" value="1.00" /></div>
        <div><label>Grip weight</label><input id="wGrip" type="number" step="0.01" value="1.00" /></div>
        <div><label>Sway weight</label><input id="wSway" type="number" step="0.01" value="1.00" /></div>
      </div>
      <div style="margin-top:8px"><label>Years per Z (k)</label><input id="kYearsPerZ" type="number" step="0.1" value="15" /></div>
    </div>

    <div style="margin-top:12px"><button id="btnCalculate" class="btn">Calculate</button></div>

    <h3 style="margin-top:20px">Results</h3>
    <div class="grid2">
      <div class="card"><div class="kv">Mobility Age</div><div id="outMobilityAge" style="font-size:28px;font-weight:800;margin-top:6px">—</div><div class="kv">Age − (WeightedZ × 15)</div></div>
      <div class="card"><div class="kv">Weighted Z (composite)</div><div id="outWeightedZ" style="font-size:28px;font-weight:800;margin-top:6px">—</div><div class="kv">Weights: VO2 1.50, TUG 1.25, others 1.00</div></div>
    </div>

    <div class="card" style="margin-top:12px;overflow:auto">
      <table class="table"><thead><tr><th>Measure</th><th>Input</th><th>Mean</th><th>SD</th><th>Z</th><th>Weight</th><th>Weighted Z</th></tr></thead><tbody id="tblBody"></tbody></table>
    </div>
  </div>

  <script>

document.addEventListener('DOMContentLoaded', function(){
  // Boot
  var boot = document.getElementById('boot'); if(boot) boot.textContent = 'Boot: OK';
  function EL(id){return document.getElementById(id);}
  function setTxt(id, t){var el=EL(id); if(el) el.textContent=t;}
  setTxt('core','Core: engine loaded');

  var EMBEDDED_NORMS = [{"Test":"Sit & Reach","Sex":"Male","AgeStart":20,"AgeEnd":29,"Mean":15.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Male","AgeStart":30,"AgeEnd":39,"Mean":14.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Male","AgeStart":40,"AgeEnd":49,"Mean":13.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Male","AgeStart":50,"AgeEnd":59,"Mean":12.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Male","AgeStart":60,"AgeEnd":69,"Mean":11.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Male","AgeStart":70,"AgeEnd":79,"Mean":10.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Male","AgeStart":80,"AgeEnd":89,"Mean":9.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Female","AgeStart":20,"AgeEnd":29,"Mean":17.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Female","AgeStart":30,"AgeEnd":39,"Mean":16.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Female","AgeStart":40,"AgeEnd":49,"Mean":15.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Female","AgeStart":50,"AgeEnd":59,"Mean":14.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Female","AgeStart":60,"AgeEnd":69,"Mean":13.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Female","AgeStart":70,"AgeEnd":79,"Mean":12.0,"SD":3.0},{"Test":"Sit & Reach","Sex":"Female","AgeStart":80,"AgeEnd":89,"Mean":11.0,"SD":3.0},{"Test":"TUG","Sex":"Male","AgeStart":20,"AgeEnd":29,"Mean":6.0,"SD":1.0},{"Test":"TUG","Sex":"Male","AgeStart":30,"AgeEnd":39,"Mean":7.0,"SD":1.0},{"Test":"TUG","Sex":"Male","AgeStart":40,"AgeEnd":49,"Mean":8.0,"SD":1.0},{"Test":"TUG","Sex":"Male","AgeStart":50,"AgeEnd":59,"Mean":9.0,"SD":1.0},{"Test":"TUG","Sex":"Male","AgeStart":60,"AgeEnd":69,"Mean":10.0,"SD":1.0},{"Test":"TUG","Sex":"Male","AgeStart":70,"AgeEnd":79,"Mean":11.0,"SD":1.0},{"Test":"TUG","Sex":"Male","AgeStart":80,"AgeEnd":89,"Mean":12.0,"SD":1.0},{"Test":"TUG","Sex":"Female","AgeStart":20,"AgeEnd":29,"Mean":6.5,"SD":1.0},{"Test":"TUG","Sex":"Female","AgeStart":30,"AgeEnd":39,"Mean":7.5,"SD":1.0},{"Test":"TUG","Sex":"Female","AgeStart":40,"AgeEnd":49,"Mean":8.5,"SD":1.0},{"Test":"TUG","Sex":"Female","AgeStart":50,"AgeEnd":59,"Mean":9.5,"SD":1.0},{"Test":"TUG","Sex":"Female","AgeStart":60,"AgeEnd":69,"Mean":10.5,"SD":1.0},{"Test":"TUG","Sex":"Female","AgeStart":70,"AgeEnd":79,"Mean":11.5,"SD":1.0},{"Test":"TUG","Sex":"Female","AgeStart":80,"AgeEnd":89,"Mean":12.5,"SD":1.0},{"Test":"VO2","Sex":"Male","AgeStart":20,"AgeEnd":29,"Mean":50.0,"SD":5.0},{"Test":"VO2","Sex":"Male","AgeStart":30,"AgeEnd":39,"Mean":46.0,"SD":5.0},{"Test":"VO2","Sex":"Male","AgeStart":40,"AgeEnd":49,"Mean":42.0,"SD":5.0},{"Test":"VO2","Sex":"Male","AgeStart":50,"AgeEnd":59,"Mean":38.0,"SD":5.0},{"Test":"VO2","Sex":"Male","AgeStart":60,"AgeEnd":69,"Mean":34.0,"SD":5.0},{"Test":"VO2","Sex":"Male","AgeStart":70,"AgeEnd":79,"Mean":30.0,"SD":5.0},{"Test":"VO2","Sex":"Male","AgeStart":80,"AgeEnd":89,"Mean":26.0,"SD":5.0},{"Test":"VO2","Sex":"Female","AgeStart":20,"AgeEnd":29,"Mean":40.0,"SD":4.5},{"Test":"VO2","Sex":"Female","AgeStart":30,"AgeEnd":39,"Mean":36.5,"SD":4.5},{"Test":"VO2","Sex":"Female","AgeStart":40,"AgeEnd":49,"Mean":33.0,"SD":4.5},{"Test":"VO2","Sex":"Female","AgeStart":50,"AgeEnd":59,"Mean":29.5,"SD":4.5},{"Test":"VO2","Sex":"Female","AgeStart":60,"AgeEnd":69,"Mean":26.0,"SD":4.5},{"Test":"VO2","Sex":"Female","AgeStart":70,"AgeEnd":79,"Mean":22.5,"SD":4.5},{"Test":"VO2","Sex":"Female","AgeStart":80,"AgeEnd":89,"Mean":19.0,"SD":4.5}];

  function clamp(x,lo,hi){return Math.min(Math.max(x,lo),hi);}
  function invErf(x){var a=0.147,s=(x<0)?-1:1,ln=Math.log(1-x*x),t=(2/(Math.PI*a))+ln/2,inside=t*t - ln/a;return s*Math.sqrt(Math.sqrt(inside)-t);}
  function normSInv(p){if(p<=0)return -Infinity; if(p>=1)return Infinity; return Math.SQRT2*invErf(2*p-1);}
  function mean(arr){for(var s=0,i=0;i<arr.length;i++)s+=arr[i]; return s/arr.length;}
  function normTestName(t){ if(!t)return''; t=String(t).trim().toLowerCase(); t=t.split(' and ').join(' & ').split('vo₂').join('vo2'); if(t.indexOf('tug')>-1||t.indexOf('timed up')>-1)return 'tug'; if(t.indexOf('sit')>-1&&t.indexOf('reach')>-1)return 'sit & reach'; if(t.indexOf('vo2')===0||t==='vo2'||t.indexOf('vo2max')>-1||t.indexOf('vo2 max')>-1)return 'vo2'; return t; }
  function normSex(s){ if(!s)return''; s=String(s).trim().toLowerCase(); if(s.indexOf('m')===0)return'male'; if(s.indexOf('f')===0)return'female'; return s; }

  var NormsDB={ data:{} };
  NormsDB.addRow = function(test,sex,start,end,meanVal,sdVal){
    test=normTestName(test); sex=normSex(sex); if(!test||!sex)return;
    var mid=(Number(start)+Number(end))/2;
    var row={mid:Number(mid),start:Number(start),end:Number(end),mean:Number(meanVal),sd:Number(sdVal)};
    if(!this.data[test]) this.data[test]={};
    if(!this.data[test][sex]) this.data[test][sex]=[];
    this.data[test][sex].push(row);
    this.data[test][sex].sort(function(a,b){return a.mid-b.mid;});
  };
  NormsDB.interpolate=function(test,sex,age){
    test=normTestName(test); sex=normSex(sex);
    var rows=(this.data[test]&&this.data[test][sex])?this.data[test][sex]:null; if(!rows||rows.length===0) return null;
    if(rows.length===1) return {mean:rows[0].mean,sd:rows[0].sd};
    if(age<=rows[0].mid) return {mean:rows[0].mean,sd:rows[0].sd};
    if(age>=rows[rows.length-1].mid) return {mean:rows[rows.length-1].mean,sd:rows[rows.length-1].sd};
    for(var i=0;i<rows.length-1;i++){ var a=rows[i],b=rows[i+1];
      if(age>=a.mid && age<=b.mid){ var t=(age-a.mid)/(b.mid-a.mid); return {mean:a.mean+t*(b.mean-a.mean), sd:a.sd+t*(b.sd-a.sd)}; }
    } return {mean:rows[0].mean,sd:rows[0].sd};
  };

  try{
    for(var i=0;i<EMBEDDED_NORMS.length;i++){ var r=EMBEDDED_NORMS[i];
      NormsDB.addRow(r.Test,r.Sex,Number(r.AgeStart),Number(r.AgeEnd),Number(r.Mean),Number(r.SD));
    }
    setTxt('normsStatus','Norms: loaded ('+Object.keys(NormsDB.data).join(', ')+')');
  }catch(e){
    setTxt('normsStatus','Norms: ERROR');
    var err=EL('err'); if(err){ err.style.display='block'; err.textContent='Norms load error: '+e.message; }
  }

  function toNum(v){ var x=Number(v); return isFinite(x)?x:null; }
  function getVal(id, fallback){ var el=EL(id); if(!el) return fallback; var n=Number(el.value); return isFinite(n)?n:fallback; }
  function avgPct(a,b){ var arr=[]; if(a!==null&&isFinite(a))arr.push(a); if(b!==null&&isFinite(b))arr.push(b); return arr.length?mean(arr):null; }
  function fmt(x,d){ if(d===undefined)d=2; if(x===null||typeof x==='undefined'||!isFinite(x))return '&mdash;'; return Number(x).toFixed(d); }

  window.doReset=function(){
    var ids=['inpName','inpSex','inpAge','inpTUG','inpSR','inpVO2','inpMTPpct','inpGripR','inpGripL','inpSwayR','inpSwayL','wVO2','wTUG','wSR','wMTP','wGrip','wSway','kYearsPerZ'];
    for(var i=0;i<ids.length;i++){ var el=EL(ids[i]); if(!el)continue; if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }
    var ga=EL('gripAvgLbl'); if(ga) ga.textContent='Average: —';
    var sa=EL('swayAvgLbl'); if(sa) sa.textContent='Average: —';
    var tb=EL('tblBody'); if(tb) tb.innerHTML='';
    setTxt('outWeightedZ','—'); setTxt('outMobilityAge','—');
    var e=EL('err'); if(e){ e.style.display='none'; e.textContent=''; }
  };

  function compute(){
    try{
      var sexEl=EL('inpSex'); var ageEl=EL('inpAge');
      if(!sexEl||!ageEl){ var e0=EL('err'); if(e0){ e0.style.display='block'; e0.textContent='UI missing. Please re-open the file.'; } return; }
      var sex=sexEl.value; var age=Number(ageEl.value);
      if(!sex||!isFinite(age)){ var e=EL('err'); e.style.display='block'; e.textContent='Please select Sex and enter Age.'; return; }
      var weights={ VO2:getVal('wVO2',1.5), TUG:getVal('wTUG',1.25), SR:getVal('wSR',1.0), MTP:getVal('wMTP',1.0), Grip:getVal('wGrip',1.0), Sway:getVal('wSway',1.0) };
      var TUG=toNum(EL('inpTUG')?EL('inpTUG').value:null), SR=toNum(EL('inpSR')?EL('inpSR').value:null), VO2=toNum(EL('inpVO2')?EL('inpVO2').value:null);
      var MTPpct=toNum(EL('inpMTPpct')?EL('inpMTPpct').value:null), GripR=toNum(EL('inpGripR')?EL('inpGripR').value:null), GripL=toNum(EL('inpGripL')?EL('inpGripL').value:null);
      var SwayR=toNum(EL('inpSwayR')?EL('inpSwayR').value:null), SwayL=toNum(EL('inpSwayL')?EL('inpSwayL').value:null);
      var rows=[]; function getNorm(t){ var N=NormsDB.interpolate(t,sex,age); return N||{mean:null,sd:null}; };

      if(TUG!==null){ var N=getNorm('tug'); var z=null,mn=null,sd=null; if(N&&isFinite(N.mean)&&isFinite(N.sd)&&N.sd>0){ mn=N.mean; sd=N.sd; z= -((TUG-N.mean)/N.sd); } rows.push({label:'TUG (s)',input:TUG,mean:mn,sd:sd,z:z,w:weights.TUG}); } else rows.push({label:'TUG (s)',input:null,mean:null,sd:null,z:null,w:weights.TUG});
      if(SR!==null){ var N2=getNorm('sit & reach'); var z2=null,mn2=null,sd2=null; if(N2&&isFinite(N2.mean)&&isFinite(N2.sd)&&N2.sd>0){ mn2=N2.mean; sd2=N2.sd; z2=(SR-N2.mean)/N2.sd; } rows.push({label:'Sit & Reach (in)',input:SR,mean:mn2,sd:sd2,z:z2,w:weights.SR}); } else rows.push({label:'Sit & Reach (in)',input:null,mean:null,sd:null,z:null,w:weights.SR});
      if(VO2!==null){ var N3=getNorm('vo2'); var z3=null,mn3=null,sd3=null; if(N3&&isFinite(N3.mean)&&N3.sd>0){ mn3=N3.mean; sd3=N3.sd; z3=(VO2-N3.mean)/N3.sd; } rows.push({label:'VO<sub>2</sub>max (ml/kg/min)',input:VO2,mean:mn3,sd:sd3,z:z3,w:weights.VO2}); } else rows.push({label:'VO<sub>2</sub>max (ml/kg/min)',input:null,mean:null,sd:null,z:null,w:weights.VO2});

      if(MTPpct!==null){ var p=clamp(MTPpct/100,1e-6,1-1e-6); rows.push({label:'MTP (percentile)',input:MTPpct,mean:null,sd:null,z:normSInv(p),w:weights.MTP}); } else rows.push({label:'MTP (percentile)',input:null,mean:null,sd:null,z:null,w:weights.MTP});
      var gripAvg=(GripR!==null||GripL!==null)?avgPct(GripR,GripL):null; if(EL('gripAvgLbl')) EL('gripAvgLbl').textContent='Average: '+(gripAvg===null?'—':gripAvg.toFixed(2)+'%');
      if(gripAvg!==null){ var p2=clamp(gripAvg/100,1e-6,1-1e-6); rows.push({label:'Grip (avg percentile)',input:gripAvg,mean:null,sd:null,z:normSInv(p2),w:weights.Grip}); } else rows.push({label:'Grip (avg percentile)',input:null,mean:null,sd:null,z:null,w:weights.Grip});
      var swayAvg=(SwayR!==null||SwayL!==null)?avgPct(SwayR,SwayL):null; if(EL('swayAvgLbl')) EL('swayAvgLbl').textContent='Average: '+(swayAvg===null?'—':swayAvg.toFixed(2)+'%');
      if(swayAvg!==null){ var p3=clamp(swayAvg/100,1e-6,1-1e-6); rows.push({label:'Sway (avg percentile)',input:swayAvg,mean:null,sd:null,z:normSInv(p3),w:weights.Sway}); } else rows.push({label:'Sway (avg percentile)',input:null,mean:null,sd:null,z:null,w:weights.Sway});

      var tbody=EL('tblBody'); if(tbody){ tbody.innerHTML=''; var sumWZ=0,sumW=0;
        for(var j=0;j<rows.length;j++){ var r=rows[j]; var tr=document.createElement('tr');
          var wz=(r.z!==null&&isFinite(r.z))?r.z*r.w:null;
          tr.innerHTML='<td>'+r.label+'</td><td>'+fmt(r.input)+'</td><td>'+fmt(r.mean)+'</td><td>'+fmt(r.sd)+'</td><td>'+fmt(r.z,3)+'</td><td>'+fmt(r.w,2)+'</td><td>'+fmt(wz,3)+'</td>';
          tbody.appendChild(tr);
          if(r.z!==null&&isFinite(r.z)&&r.w!==null&&isFinite(r.w)){ sumWZ+=r.z*r.w; sumW+=r.w; }
        }
        var composite=sumW>0?(sumWZ/sumW):null;
        setTxt('outWeightedZ', composite===null?'—':composite.toFixed(3));
        var age2=Number(ageEl.value); var k=getVal('kYearsPerZ',15);
        var mobilityAge=(composite!==null&&isFinite(composite)&&isFinite(age2))?(age2 - composite*k):null;
        setTxt('outMobilityAge', mobilityAge===null?'—':mobilityAge.toFixed(1)+' yrs');
        var e=EL('err'); if(e){ e.style.display='none'; e.textContent=''; }
      }
    }catch(ex){ var e2=EL('err'); if(e2){ e2.style.display='block'; e2.textContent='Compute fatal: '+ex.message; } }
  }

  var btn=EL('btnCalculate'); if(btn) btn.addEventListener('click', compute);
  var ids=['inpSex','inpAge','inpTUG','inpSR','inpVO2','inpMTPpct','inpGripR','inpGripL','inpSwayR','inpSwayL','wVO2','wTUG','wSR','wMTP','wGrip','wSway','kYearsPerZ'];
  ids.forEach(function(id){ var el=EL(id); if(el){ el.addEventListener('input', compute); el.addEventListener('change', compute); } });
});

  </script>
</body>
</html>
