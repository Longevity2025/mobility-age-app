
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mobility Age — v9.26 (caps added)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#fafafa;color:#111}
  .wrap{max-width:980px;margin:24px auto;padding:0 12px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  .row{display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:center}
  input,select{font:inherit;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px}
  input[type=number]{width:100%}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:left}
  .note{font-size:12px;color:#666}
  #ok{display:block;background:#dcfce7;border:1px solid #86efac;color:#065f46;padding:10px;border-radius:10px;margin-bottom:10px}
  #dbg{display:block;background:#eef2ff;border:1px solid #c7d2fe;color:#1e3a8a;padding:10px;border-radius:10px;margin-top:8px;white-space:pre-wrap}
  #err{display:none;background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d;padding:10px;border-radius:10px;margin-top:10px;white-space:pre-wrap}
  #hb{font-size:12px;color:#0a0;margin-top:6px}
  .toolbar{display:flex;gap:8px;margin:8px 0}
  .btn{background:#111;color:#fff;border-radius:10px;padding:8px 12px;border:none;cursor:pointer}
  .btn:active{transform:translateY(1px)}
</style>

<!-- Injected creative theme [SENIOR THEME] -->
<style>

:root{
  --bg: #ffffff;
  --panel: #ffffff;
  --ink: #0b141a;
  --muted: #2b3a44;
  --accent: #0052cc;
  --accent-ink: #ffffff;
  --border: #cbd5e1;
  --focus: #99c2ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: Segoe UI, system-ui, -apple-system, Roboto, Helvetica, Arial;
  color: var(--ink);
  background: var(--bg);
  line-height: 1.6;
  font-size: 18px;
}
header{
  position: sticky; top:0; z-index: 50;
  background: #f8fafc;
  border-bottom: 2px solid var(--border);
  padding: 1rem 1rem;
}
header h1, header h2{ margin:0; font-weight:900; letter-spacing:.2px }
main{ max-width: 980px; margin: 1.25rem auto 2.25rem; padding: 0 1rem }
section, fieldset{
  background: var(--panel);
  border: 2px solid var(--border);
  border-radius: 20px;
  padding: 1.25rem;
  margin: 1rem 0;
}
label{ display:block; font-weight: 900; margin: .8rem 0 .4rem; font-size: 1.05em }
input[type=text], input[type=number], select{
  width: 100%;
  background: #fff;
  color: var(--ink);
  border: 2px solid var(--border);
  border-radius: 14px;
  padding: .9rem 1rem;
  outline: none;
}
input:focus, select:focus{
  border-color: var(--accent);
  box-shadow: 0 0 0 4px var(--focus);
}
input::placeholder{ color: #64748b; opacity:.9 }
button{
  appearance:none;
  border: 2px solid var(--accent);
  background: var(--accent);
  color: var(--accent-ink);
  font-weight: 900;
  padding: .9rem 1.2rem;
  border-radius: 999px;
  cursor: pointer;
  font-size: 1.05em;
}
button.secondary{ background: #fff; color: var(--accent) }
button:disabled{ opacity:.6; cursor:not-allowed }
table{ width:100%; border-collapse: collapse; font-size: 1.02em }
th,td{ padding: .8rem .6rem; border-bottom: 2px solid var(--border) }
th{ text-transform: none; font-weight: 900 }
.badge{
  display:inline-block; padding:.35rem .7rem; border-radius:999px; background:#e6f0ff; border:2px solid var(--accent); color:var(--accent)
}
.grid-2{ display:grid; grid-template-columns: 1fr; gap:1.2rem }
@media (min-width: 820px){
  .grid-2{ grid-template-columns: 1fr 1fr }
}
.output, .readout, .big-number{ font-size: 1.35em; font-weight: 900; }
@media print{
  header, button{ display:none !important }
  section, fieldset{ border: 1px solid #000 }
}

</style>
</head>
<body>
<div class="wrap">
  <div id="ok">Script booting…</div>
  <div id="hb">Heartbeat: (starting…)</div>
  <div class="toolbar">
    <button id="clearBtn" class="btn">Clear All</button>
  </div>
  <div id="dbg"></div>
  <div id="err"></div>
  <h1>Mobility Age — v9.26</h1>
  <p class="note">Capped MAEs: Sit &amp; Reach ≥ 21, TUG ≥ 21, VO₂ ≥ 21. Auto-calc every 0.5s after all fields are filled.</p>
  <div class="card">
    <h2>Inputs</h2>
    <div class="grid-2">
      <div>
        <div class="row"><label>Tester</label><input id="tester" placeholder="e.g., Jane Doe"></div>
        <div class="row"><label>Test Date</label><input id="testDate" type="date"></div>
        <div class="row"><label>Location</label><input id="location" placeholder="e.g., Clinic A"></div>
        <div class="row"><label>Member Name</label><input id="memberName" placeholder="e.g., John Smith"></div>
        <div class="row"><label>Phone (xxx-xxx-xxxx)</label><input id="phone" placeholder="555-123-4567"></div>
      </div>
      <div>
        <div class="row"><label>Sex</label>
          <select id="sex">
            <option value="" selected disabled>— Select —</option>
            <option>Male</option>
            <option>Female</option>
          </select>
        </div>
        <div class="row"><label>Age</label><input id="age" type="number" min="1" placeholder="Age in years"></div>
      </div>
    </div>
    <h3>Tests</h3>
    <div class="grid-2">
      <div>
        <div class="row"><label>Sit &amp; Reach (in)</label><input id="sit" type="number" step="0.01" placeholder="inches"></div>
        <div class="row"><label>TUG (sec)</label><input id="tug" type="number" step="0.01" placeholder="seconds"></div>
        <div class="row"><label>Mid-Thigh Pull (percentile)</label><input id="mtp" type="number" min="0.01" max="99.99" step="0.01" placeholder="0.01–99.99"></div>
      </div>
      <div>
        <div class="row"><label>Postural Sway Right (percentile)</label><input id="sway_r" type="number" min="0.01" max="99.99" step="0.01" placeholder="0.01–99.99"></div>
        <div class="row"><label>Postural Sway Left (percentile)</label><input id="sway_l" type="number" min="0.01" max="99.99" step="0.01" placeholder="0.01–99.99"></div>
        <div class="row"><label>Grip Strength Right (percentile)</label><input id="grip_r" type="number" min="0.01" max="99.99" step="0.01" placeholder="0.01–99.99"></div>
        <div class="row"><label>Grip Strength Left (percentile)</label><input id="grip_l" type="number" min="0.01" max="99.99" step="0.01" placeholder="0.01–99.99"></div>
        <div class="row"><label>VO₂ Max (mL/kg/min)</label><input id="vo2" type="number" step="0.01" placeholder="ml/kg/min"></div>
      </div>
    </div>
  </div>
  <div id="results" class="card" style="margin-top:14px;">
    <h2>Results</h2>
    <div id="who"></div>
    <table><thead><tr><th>Test</th><th>Z</th><th>Weight</th><th>Weighted Z</th><th>MAE</th></tr></thead>
      <tbody id="rows"></tbody>
      <tfoot><tr><th colspan="4">Final Mobility Age</th><th id="final"></th></tr></tfoot>
    </table>
  </div>
</div>

<script id="sr_json" type="application/json">{"Male": {"20-29": {"mean": 15.0, "sd": 3.0, "mid": 24.5}, "30-39": {"mean": 14.0, "sd": 3.0, "mid": 34.5}, "40-49": {"mean": 13.0, "sd": 3.0, "mid": 44.5}, "50-59": {"mean": 12.0, "sd": 3.0, "mid": 54.5}, "60-69": {"mean": 11.0, "sd": 3.0, "mid": 64.5}, "70-79": {"mean": 10.0, "sd": 3.0, "mid": 74.5}, "80-89": {"mean": 9.0, "sd": 3.0, "mid": 84.5}}, "Female": {"20-29": {"mean": 17.0, "sd": 3.0, "mid": 24.5}, "30-39": {"mean": 16.0, "sd": 3.0, "mid": 34.5}, "40-49": {"mean": 15.0, "sd": 3.0, "mid": 44.5}, "50-59": {"mean": 14.0, "sd": 3.0, "mid": 54.5}, "60-69": {"mean": 13.0, "sd": 3.0, "mid": 64.5}, "70-79": {"mean": 12.0, "sd": 3.0, "mid": 74.5}, "80-89": {"mean": 11.0, "sd": 3.0, "mid": 84.5}}}</script>
<script id="tug_json" type="application/json">{"Male": {"20-29": {"mean": 6.0, "sd": 1.0, "mid": 24.5}, "30-39": {"mean": 7.0, "sd": 1.0, "mid": 34.5}, "40-49": {"mean": 8.0, "sd": 1.0, "mid": 44.5}, "50-59": {"mean": 9.0, "sd": 1.0, "mid": 54.5}, "60-69": {"mean": 10.0, "sd": 1.0, "mid": 64.5}, "70-79": {"mean": 11.0, "sd": 1.0, "mid": 74.5}, "80-89": {"mean": 12.0, "sd": 1.0, "mid": 84.5}}, "Female": {"20-29": {"mean": 6.5, "sd": 1.0, "mid": 24.5}, "30-39": {"mean": 7.5, "sd": 1.0, "mid": 34.5}, "40-49": {"mean": 8.5, "sd": 1.0, "mid": 44.5}, "50-59": {"mean": 9.5, "sd": 1.0, "mid": 54.5}, "60-69": {"mean": 10.5, "sd": 1.0, "mid": 64.5}, "70-79": {"mean": 11.5, "sd": 1.0, "mid": 74.5}, "80-89": {"mean": 12.5, "sd": 1.0, "mid": 84.5}}}</script>
<script id="vo2_json" type="application/json">{"Male": {"20-29": {"mean": 50.0, "sd": 5.0, "mid": 24.5}, "30-39": {"mean": 46.0, "sd": 5.0, "mid": 34.5}, "40-49": {"mean": 42.0, "sd": 5.0, "mid": 44.5}, "50-59": {"mean": 38.0, "sd": 5.0, "mid": 54.5}, "60-69": {"mean": 34.0, "sd": 5.0, "mid": 64.5}, "70-79": {"mean": 30.0, "sd": 5.0, "mid": 74.5}, "80-89": {"mean": 26.0, "sd": 5.0, "mid": 84.5}}, "Female": {"20-29": {"mean": 40.0, "sd": 4.5, "mid": 24.5}, "30-39": {"mean": 36.5, "sd": 4.5, "mid": 34.5}, "40-49": {"mean": 33.0, "sd": 4.5, "mid": 44.5}, "50-59": {"mean": 29.5, "sd": 4.5, "mid": 54.5}, "60-69": {"mean": 26.0, "sd": 4.5, "mid": 64.5}, "70-79": {"mean": 22.5, "sd": 4.5, "mid": 74.5}, "80-89": {"mean": 19.0, "sd": 4.5, "mid": 84.5}}}</script>
<script id="slopes_json" type="application/json">{"sit_reach": 0.0, "tug": 0.0, "vo2": 0.0}</script>

<script>
(function(){
  var t=0;
  setInterval(function(){
    t = t + 1;
    var hb = document.getElementById('hb');
    if(hb){ hb.textContent = 'Heartbeat: tick ' + t; }
  }, 500);

  function parseJ(id){ var el=document.getElementById(id); try{ return JSON.parse(el.textContent); }catch(e){ return {}; } }
  var SIT = parseJ('sr_json'), TUG = parseJ('tug_json'), VO2 = parseJ('vo2_json'), SLP = parseJ('slopes_json');

  var ok = document.getElementById('ok');
  if(ok){
    function c(g){ return [Object.keys(g.Male||{}).length, Object.keys(g.Female||{}).length]; }
    var cs = c(SIT), ct = c(TUG), cv = c(VO2);
    ok.textContent = 'Script loaded. Norm bins — SR ' + cs[0] + ' / ' + cs[1] + ', TUG ' + ct[0] + ' / ' + ct[1] + ', VO2 ' + cv[0] + ' / ' + cv[1];
  }

  function parseRange(label){
    if(!label) return null;
    var s = label.toString().trim();
    s = s.replace(/[\u2013\u2014]/g,'-');
    var m = s.match(/(\d+)\s*-\s*(\d+)/);
    if(m) return [parseInt(m[1],10), parseInt(m[2],10)];
    m = s.match(/(\d+)\D+(\d+)/);
    if(m) return [parseInt(m[1],10), parseInt(m[2],10)];
    m = s.match(/(\d+)\s*\+$/);
    if(m) return [parseInt(m[1],10), parseInt(m[1],10)+9];
    m = s.match(/(\d+)/);
    if(m) return [parseInt(m[1],10), parseInt(m[1],10)];
    return null;
  }

  function pickAgeGroup(age, node){
    var keys = Object.keys(node||{});
    var best = null, bestDist = Infinity;
    for(var i=0;i<keys.length;i++){
      var k = keys[i];
      var r = parseRange(k);
      if(!r) continue;
      var mid = (r[0] + r[1]) / 2;
      if(age >= r[0] && age <= r[1]){
        return {label:k, mid:mid, r:r};
      }
      var d = Math.abs(age - mid);
      if(d < bestDist){
        bestDist = d; best = {label:k, mid:mid, r:r};
      }
    }
    return best;
  }

  function normSInv(p){
    if(!(p>0 && p<1)){ return NaN; }
    var a=[-39.69683028665376,220.9460984245205,-275.9285104469687,138.3577518672690,-30.66479806614716,2.506628277459239];
    var b=[-54.47609879822406,161.5858368580409,-155.6989798598866,66.80131188771972,-13.28068155288572];
    var c=[-0.007784894002430293,-0.3223964580411365,-2.400758277161838,-2.549732539343734,4.374664141464968,2.938163982698783];
    var d=[0.007784695709041462,0.3224671290700398,2.445134137142996,3.754408661907416];
    var plow=0.02425, phigh=1-plow, q, r;
    if(p<plow){
      q = Math.sqrt(-2*Math.log(p));
      var num = (((((c[0]*q + c[1])*q + c[2])*q + c[3])*q + c[4])*q + c[5]);
      var den = ((((d[0]*q + d[1])*q + d[2])*q + d[3])*q + 1);
      return num/den;
    } else if (p>phigh){
      q = Math.sqrt(-2*Math.log(1-p));
      var num2 = (((((c[0]*q + c[1])*q + c[2])*q + c[3])*q + c[4])*q + c[5]);
      var den2 = ((((d[0]*q + d[1])*q + d[2])*q + d[3])*q + 1);
      return -num2/den2;
    } else {
      q = p - 0.5;
      r = q*q;
      var num3 = (((((a[0]*r + a[1])*r + a[2])*r + a[3])*r + a[4])*r + a[5]) * q;
      var den3 = (((((b[0]*r + b[1])*r + b[2])*r + b[3])*r + b[4])*r + 1);
      return num3/den3;
    }
  }

  function zFromRaw(raw, mean, sd, invert){
    if(!isFinite(sd) || sd===0){ return 0; }
    var z=(raw-mean)/sd;
    if(invert){ z = -z; }
    return z;
  }
  function zFromPct(p){ return normSInv(p/100); }
  function clamp(x,lo,hi){ if(x<lo) return lo; if(x>hi) return hi; return x; }

  function requiredFilled(){
    var age = document.getElementById('age').value.trim();
    var sex = document.getElementById('sex').value.trim();
    var ids = ['sit','tug','mtp','sway_r','sway_l','grip_r','grip_l','vo2'];
    if(!(age && sex)) return false;
    for(var i=0;i<ids.length;i++){
      var v = document.getElementById(ids[i]).value.trim();
      if(!v) return false;
    }
    return true;
  }

  function clearAll(){
    var ids = ['tester','location','memberName','phone','age','sit','tug','mtp','sway_r','sway_l','grip_r','grip_l','vo2'];
    for(var i=0;i<ids.length;i++){ var el=document.getElementById(ids[i]); if(el){ el.value=''; } }
    var sex = document.getElementById('sex');
    if(sex){ sex.value=''; }
    var tbody = document.getElementById('rows'); if(tbody){ tbody.innerHTML=''; }
    var fin = document.getElementById('final'); if(fin){ fin.textContent=''; }
  }
  window.__clearAll = clearAll;

  function render(){
    var dbg = document.getElementById('dbg'), errBox = document.getElementById('err');
    try{
      var fin = document.getElementById('final');
      var tbody = document.getElementById('rows');
      if(!requiredFilled()){
        if(tbody){ tbody.innerHTML=''; }
        if(fin){ fin.textContent=''; }
        if(dbg){ dbg.textContent='Fill all fields to calculate.'; }
        return;
      }

      var sex = document.getElementById('sex').value;
      var age = Number(document.getElementById('age').value)||0;
      function num(id){ var v = Number(document.getElementById(id).value); return isFinite(v)?v:0; }
      var sit=num('sit'), tugRaw=num('tug'), mtpPct=num('mtp'), vo2Raw=num('vo2');
      var sway_r_pct=clamp(num('sway_r'),0.0001,99.9999), sway_l_pct=clamp(num('sway_l'),0.0001,99.9999);
      var grip_r_pct=clamp(num('grip_r'),0.0001,99.9999), grip_l_pct=clamp(num('grip_l'),0.0001,99.9999);

      var srPick=pickAgeGroup(age,(SIT[sex]||{}));
      var tgPick=pickAgeGroup(age,(TUG[sex]||{}));
      var v2Pick=pickAgeGroup(age,(VO2[sex]||{}));

      function nodeFor(pick, map){ if(!pick) return {mean:0,sd:1,mid:0}; var d = map[pick.label]||{}; return {mean:d.mean||0, sd:d.sd||1, mid:(d.mid!=null?d.mid:pick.mid)}; }
      var sr = nodeFor(srPick, SIT[sex]||{}), tg = nodeFor(tgPick, TUG[sex]||{}), v2 = nodeFor(v2Pick, VO2[sex]||{});

      var srSlope = (SLP && SLP.sit_reach)?SLP.sit_reach:0;
      var tgSlope = (SLP && SLP.tug)?SLP.tug:0;
      var v2Slope = (SLP && SLP.vo2)?SLP.vo2:0;

      var srMeanAdj = sr.mean + srSlope*(age - sr.mid);
      var tgMeanAdj = tg.mean + tgSlope*(age - tg.mid);
      var v2MeanAdj = v2.mean + v2Slope*(age - v2.mid);

      var z_sit=zFromRaw(sit,srMeanAdj,sr.sd,false);
      var z_tug_raw=zFromRaw(tugRaw,tgMeanAdj,tg.sd,true);
      var z_vo2=zFromRaw(vo2Raw,v2MeanAdj,v2.sd,false);
      var z_mtp=zFromPct(mtpPct);
      var z_sway=zFromPct((sway_r_pct+sway_l_pct)/2.0);
      var z_grip=zFromPct((grip_r_pct+grip_l_pct)/2.0);

      var w={sit:1.0,tug:1.25,mtp:1.0,sway:1.0,grip:1.0,vo2:1.5};
      var wz={sit:z_sit*w.sit, tug:z_tug_raw*w.tug, mtp:z_mtp*w.mtp, sway:z_sway*w.sway, grip:z_grip*w.grip, vo2:z_vo2*w.vo2};

      // Apply MAE caps (>=21) for Sit & Reach, TUG, and VO2
      var mae={ 
        sit:Math.max(21, age-15*wz.sit), 
        tug:Math.max(21, age-15*wz.tug), 
        mtp:age-15*wz.mtp, 
        sway:age-15*wz.sway, 
        grip:age-15*wz.grip, 
        vo2:Math.max(21, age-15*wz.vo2) 
      };

      var final=(mae.sit+mae.tug+mae.mtp+mae.sway+mae.grip+mae.vo2)/6.0;

      var who = document.getElementById('who');
      if(who){ who.textContent='Member: '+(document.getElementById('memberName').value||'(No name)')+' • Age: '+age+' • Sex: '+sex; }
      if(tbody){
        tbody.innerHTML = ''
          + '<tr><td>Sit & Reach (in)</td><td>'+z_sit.toFixed(2)+'</td><td>'+w.sit.toFixed(2)+'</td><td>'+wz.sit.toFixed(2)+'</td><td>'+mae.sit.toFixed(2)+'</td></tr>'
          + '<tr><td>TUG (cap ≥21 after weighting)</td><td>'+z_tug_raw.toFixed(2)+'</td><td>'+w.tug.toFixed(2)+'</td><td>'+wz.tug.toFixed(2)+'</td><td>'+mae.tug.toFixed(2)+'</td></tr>'
          + '<tr><td>Mid-Thigh Pull</td><td>'+z_mtp.toFixed(2)+'</td><td>'+w.mtp.toFixed(2)+'</td><td>'+wz.mtp.toFixed(2)+'</td><td>'+mae.mtp.toFixed(2)+'</td></tr>'
          + '<tr><td>Postural Sway (avg R/L pct)</td><td>'+z_sway.toFixed(2)+'</td><td>'+w.sway.toFixed(2)+'</td><td>'+wz.sway.toFixed(2)+'</td><td>'+mae.sway.toFixed(2)+'</td></tr>'
          + '<tr><td>Grip Strength (avg R/L pct)</td><td>'+z_grip.toFixed(2)+'</td><td>'+w.grip.toFixed(2)+'</td><td>'+wz.grip.toFixed(2)+'</td><td>'+mae.grip.toFixed(2)+'</td></tr>'
          + '<tr><td>VO₂ Max</td><td>'+z_vo2.toFixed(2)+'</td><td>'+w.vo2.toFixed(2)+'</td><td>'+wz.vo2.toFixed(2)+'</td><td>'+mae.vo2.toFixed(2)+'</td></tr>';
      }
      if(fin){ fin.textContent = final.toFixed(2); }

      var dbg = document.getElementById('dbg');
      if(dbg){
        var txt='Picked bins:\n';
        txt += '  SR: ' + (srPick?srPick.label:'(none)') + ' mid=' + (sr.mid) + ' mean=' + sr.mean + ' sd=' + sr.sd + '\n';
        txt += '  TUG: ' + (tgPick?tgPick.label:'(none)') + ' mid=' + (tg.mid) + ' mean=' + tg.mean + ' sd=' + tg.sd + '\n';
        txt += '  VO2: ' + (v2Pick?v2Pick.label:'(none)') + ' mid=' + (v2.mid) + ' mean=' + v2.mean + ' sd=' + v2.sd + '\n';
        dbg.textContent = txt;
      }
      if(errBox){ errBox.style.display='none'; }
    }catch(e){
      if(errBox){
        errBox.style.display='block';
        errBox.textContent='Calc Error: '+ (e && e.message ? e.message : e);
      }
    }
  }

  // Hook up Clear button
  document.addEventListener('click', function(ev){
    if(ev.target && ev.target.id === 'clearBtn'){
      ev.preventDefault();
      clearAll();
    }
  });

  // Start empty (except date)
  function startEmpty(){
    clearAll();
    var td = document.getElementById('testDate');
    if(td){ try{ td.value = new Date().toISOString().slice(0,10); }catch(e){} }
  }
  startEmpty();

  // Render timer
  setInterval(render, 500);
})();
</script>
</body>
</html>
